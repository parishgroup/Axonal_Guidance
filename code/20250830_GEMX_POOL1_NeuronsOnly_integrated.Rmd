---
title: "20250408_GEMX_POOL1_NeuronsOnly_integrated.Rmd"
output: html_document
date: "2025-04-08"
---

```{r setup, include=FALSE}
library(Seurat)
library(dplyr)
library(remotes)
library(R.utils)
library(harmony)
library(hdf5r)
library(clustree)
library(RColorBrewer)
library(tidyverse)
library(pander)
library(patchwork)
library(ggplot2)
library(BiocManager)
library(cowplot)
library(purrr)
library(scuttle)
library(SingleCellExperiment)
library(DropletUtils)
library(Matrix)
library(scran)
library(HGNChelper)
library(openxlsx)
library(ggpubr)
library(presto)
library(edgeR)
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(EnhancedVolcano)
library(ggrepel)
library(ggarchery)
library (colorspace)
library(paletteer)
library(fgsea)
library(pathview)
```

```{r, include=FALSE}
#set the working directory
setwd("/data/gpfs/projects/punim2346/chiara/projects/axonal_guidance/analyses/R_output/20250317_GEMX_FLEX_POOL1/Merged")
# Specify the folder path and file name
output_folder <- "/data/gpfs/projects/punim2346/chiara/projects/axonal_guidance/analyses/R_output/20250317_GEMX_FLEX_POOL1/Merged/Graphs_Neurons_Only"  
```

# Load the objects

```{r load_object}
SampleMerged_Int<-readRDS(file =  "/data/gpfs/projects/punim2346/chiara/projects/axonal_guidance/analyses/R_output/20250317_GEMX_FLEX_POOL1/Merged/Data/SampleMerged_Int.rds")
DimPlot(SampleMerged_Int)

```

#Subset Neurons
```{r Neurons, results='hide', message=FALSE}
NeuronsOnly<-subset(SampleMerged_Int, subset = cell_type == "Neurons")
DimPlot(NeuronsOnly,  cols = "black")+ 
  labs(title = "UMAP Neurons")

```

# Identify highly variable features

```{r variablefeatures, message=FALSE}
NeuronsOnly <- FindVariableFeatures(NeuronsOnly, selection.method = 'vst', nfeatures = 2000)
# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(NeuronsOnly), 20)
# plot variable features with and without labels
plot2 <- VariableFeaturePlot(NeuronsOnly)
plot2 <- LabelPoints(plot = plot2, points = top10, repel = TRUE, max.overlaps = Inf) 
plot2
```

# Scaling the data

```{r scaling, message=FALSE}
all.genes <- rownames(NeuronsOnly)
NeuronsOnly <- ScaleData(NeuronsOnly, features = all.genes)
```

# Perform Dimensional Reduction

```{r PCA, message=FALSE}
NeuronsOnly <- RunPCA(NeuronsOnly, features = VariableFeatures(object = NeuronsOnly))
# Examine and visualize PCA results
print(NeuronsOnly$pca, dims = 1:6, nfeatures = 5)
DimHeatmap(NeuronsOnly, dims = 1:15, cells = 500, balanced = TRUE)
#Visualization
DimPlot(NeuronsOnly, reduction='pca', group.by = "SampleID")+ labs(title = "NeuronsOnly PCA Plot Sample")  + theme(plot.title = element_text(hjust = 0.5))
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample1"), group.by = "SampleID", reduction = "pca", cols =  "#F68282") + 
  labs(title = "PCA for Sample1")
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample2"), group.by = "SampleID", reduction = "pca", cols =  "#00BA38") + 
  labs(title = "PCA for Sample2")
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample3"), group.by = "SampleID", reduction = "pca", cols =  "#619CFF") + 
  labs(title = "PCA for Sample3")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample1"),  
            features = "nCount_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample1")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample2"),  
            features = "nCount_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample2")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample3"),  
            features = "nCount_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample3")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample1"),  
            features = "nFeature_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample1")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample2"),  
            features = "nFeature_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample2")
FeaturePlot(subset(NeuronsOnly, subset = SampleID == "Sample3"),  
            features = "nFeature_RNA", 
            reduction = "pca") + 
  labs(title = "PCA for Sample3")

# Determine the dimensionality + run UMAP

ElbowPlot(NeuronsOnly)
NeuronsOnly <- RunUMAP(NeuronsOnly, dims = 1:10)

# Visualization
DimPlot(NeuronsOnly, reduction = "umap", label = TRUE, repel = TRUE, label.box = TRUE) + NoLegend()
```

#Clustering

```{r clustering, message=FALSE}
# Determine the K-nearest neighbor graph
NeuronsOnly <- FindNeighbors(NeuronsOnly, dims = 1:10)
# Determine the clusters for 0.1 resolution
NeuronsOnly <- FindClusters(NeuronsOnly, resolution = 0.6)
# Visualization
DimPlot(NeuronsOnly, reduction = "umap", label = TRUE, repel = TRUE, label.box = TRUE) + NoLegend()
```

# Clustering Visualization

```{r}
# See the different samples in the umap
DimPlot(NeuronsOnly, reduction = "umap", label = TRUE, repel = TRUE, label.box = TRUE) + NoLegend()
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample1"), reduction = "umap") + 
    labs(title = "UMAP for Sample1") + 
    theme(plot.title = element_text(hjust = 0.5))
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample2"), reduction = "umap") + 
    labs(title = "UMAP for Sample2") + 
    theme(plot.title = element_text(hjust = 0.5))
DimPlot(subset(NeuronsOnly, subset = SampleID == "Sample3"), reduction = "umap") + 
    labs(title = "UMAP for Sample3") + 
    theme(plot.title = element_text(hjust = 0.5))
# ViolinPLot nFeature
VlnPlot(NeuronsOnly, group.by = "seurat_clusters",features=c("nFeature_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample1"), group.by = "seurat_clusters",features=c("nFeature_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample2"), group.by = "seurat_clusters",features=c("nFeature_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample3"), group.by = "seurat_clusters",features=c("nFeature_RNA"))
# ViolinPLot nCount
VlnPlot(NeuronsOnly, group.by = "seurat_clusters",features=c("nCount_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample1"), group.by = "seurat_clusters",features=c("nCount_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample2"), group.by = "seurat_clusters",features=c("nCount_RNA"))
VlnPlot(subset(NeuronsOnly, subset = SampleID == "Sample3"), group.by = "seurat_clusters",features=c("nCount_RNA"))

#Visualize samples/cluster/cell distribution
# Extract necessary columns
tmp <- NeuronsOnly@meta.data[, c("nFeature_RNA", "seurat_clusters", "SampleID")]
# Convert to a data frame
tmp <- as.data.frame(tmp)

ggplot(tmp, aes(x = factor(seurat_clusters), y = nFeature_RNA, fill = SampleID)) +
  geom_boxplot(position = position_dodge(width = 0.8), outlier.shape = NA, alpha = 0.7) +
  labs(x = "Clusters", y = "nFeature_RNA", title = "nFeature_RNA distribution by Cluster and SampleID") +
  theme_classic() +
  theme(legend.position = "none")

# Summarize the data to get the mean nFeature_RNA per cluster and SampleID
summary_data <- tmp %>%
  group_by(seurat_clusters, SampleID) %>%
  summarise(mean_nFeature_RNA = mean(nFeature_RNA)) %>%
  ungroup()
# Create the plot with a single bar per cluster colored by SampleID
ggplot(summary_data, aes(x = factor(seurat_clusters), y = mean_nFeature_RNA, fill = SampleID)) +
  geom_bar(stat = "identity") +  # stat = "identity" uses the actual summarized values
  labs(x = "Clusters", y = "Mean nFeature_RNA", title = "Mean nFeature_RNA by Cluster and SampleID") 

# Extract necessary columns from metadata
tmp <- NeuronsOnly@meta.data[, c("nCount_RNA", "seurat_clusters", "SampleID")]
# Convert to a data frame
tmp <- as.data.frame(tmp)

ggplot(tmp, aes(x = factor(seurat_clusters), y = nCount_RNA, fill = SampleID)) +
  geom_boxplot(position = position_dodge(width = 0.8), outlier.shape = NA, alpha = 0.7) +
  labs(x = "Clusters", y = "nCount_RNA", title = "nCount_RNA distribution by Cluster and SampleID") +
  theme_classic() +
  theme(legend.position = "none")+
  scale_y_continuous(limits = c(0, 45000), oob = scales::squish)

# Summarize the data: Sum the nCount_RNA for each cluster and SampleID
summary_data <- tmp %>%
  group_by(seurat_clusters, SampleID) %>%
  summarise(mean_nCount_RNA = mean(nCount_RNA)) %>%
  ungroup()

# Create the bar plot with total nCount_RNA per cluster, colored by SampleID
ggplot(summary_data, aes(x = factor(seurat_clusters), y = mean_nCount_RNA, fill = SampleID)) +
  geom_bar(stat = "identity", position = "stack") +  # Use stacked bars
  labs(x = "Clusters", y = "Mean nCount_RNA", title = "Mean nCount_RNA by Cluster and SampleID")

# Extract the necessary columns from the metadata
tmp <- NeuronsOnly@meta.data[, c("seurat_clusters", "SampleID")]

# Convert to a data frame
tmp <- as.data.frame(tmp)

# Count the number of cells in each cluster, grouped by SampleID
cell_count_data <- tmp %>%
  group_by(seurat_clusters, SampleID) %>%
  summarise(cell_count = n()) %>%
  ungroup()

# Create the bar plot with the number of cells per cluster, colored by SampleID
ggplot(cell_count_data, aes(x = factor(seurat_clusters), y = cell_count, fill = SampleID)) +
  geom_bar(stat = "identity", position = "stack") +  # 'stack' to stack bars for different SampleID
  labs(x = "Clusters", y = "Number of Cells", title = "Number of Cells per Cluster and SampleID") 

```

# Markers

```{r, markers visualization}
FeaturePlot(NeuronsOnly, "GFAP")
FeaturePlot(NeuronsOnly, "TH")
FeaturePlot(NeuronsOnly, "SOX2")
FeaturePlot(NeuronsOnly, "OLIG1")
FeaturePlot(NeuronsOnly, "OLIG2")
FeaturePlot(NeuronsOnly, "SYP")
FeaturePlot(NeuronsOnly, "SYN1")
FeaturePlot(NeuronsOnly, "MAPT")
FeaturePlot(NeuronsOnly, "RBFOX3")
FeaturePlot(NeuronsOnly, "MAP2")
FeaturePlot(NeuronsOnly, "INA")
FeaturePlot(NeuronsOnly, "GAP43")
FeaturePlot(NeuronsOnly, "NRP1")
FeaturePlot(NeuronsOnly, "AQP4")
FeaturePlot(NeuronsOnly, "ELAVL3")
FeaturePlot(NeuronsOnly, "ELAVL4")
FeaturePlot(NeuronsOnly, "STMN2")
FeaturePlot(NeuronsOnly, "FOXP3")
FeaturePlot(NeuronsOnly, "RBFOX3")
FeaturePlot(NeuronsOnly, "PITX3")
FeaturePlot(NeuronsOnly, "EN1")
FeaturePlot(NeuronsOnly, "LMX1A")
FeaturePlot(NeuronsOnly, "NR4A2")
FeaturePlot(NeuronsOnly, "DRD1")
FeaturePlot(NeuronsOnly, "DRD2")
FeaturePlot(NeuronsOnly, "FOXA2")
FeaturePlot(NeuronsOnly, "KCNJ6")
FeaturePlot(NeuronsOnly, "DDC")
VlnPlot(NeuronsOnly, "GFAP")
VlnPlot(NeuronsOnly, "TH")
VlnPlot(NeuronsOnly, "SOX2")
VlnPlot(NeuronsOnly, "OLIG1")
VlnPlot(NeuronsOnly, "OLIG2")
VlnPlot(NeuronsOnly, "SYP")
VlnPlot(NeuronsOnly, "SYN1")
VlnPlot(NeuronsOnly, "MAPT")
VlnPlot(NeuronsOnly, "RBFOX3")
VlnPlot(NeuronsOnly, "MAP2")
VlnPlot(NeuronsOnly, "INA")
VlnPlot(NeuronsOnly, "NRP1")
VlnPlot(NeuronsOnly, "AQP4")
VlnPlot(NeuronsOnly, "ELAVL3")
VlnPlot(NeuronsOnly, "ELAVL4")
VlnPlot(NeuronsOnly, "STMN2")
VlnPlot(NeuronsOnly, "FOXP3")
VlnPlot(NeuronsOnly, "RBFOX3")
VlnPlot(NeuronsOnly, "GAP43")
VlnPlot(NeuronsOnly, "PITX3")
VlnPlot(NeuronsOnly, "EN1")
VlnPlot(NeuronsOnly, "PITX3")
VlnPlot(NeuronsOnly, "NR4A2")
```


```{r, message=FALSE}
# Create the list of markers
vmDAList <- list(
  "neuronalMarkers" = c("NCAM1", "MAP2", "RBFOX3", "SYN1", "SYP", "MAPT", "INA", "GAP43", "NRP1", "TUBB3"),
  "astrocytesMarker" = c ("GFAP","SOX9", "SLC1A3", "AQP4", "S100B", "ALDH1L1"),
  "NeuralStemCellsMarkers" = c ("SOX2", "PROM1", "NES", "MSI1", "VIM", "POU3F3", "L1CAM","RELN"),
  "Neuroblasts" = c ("NEUROD1", "DCX", "DLX2", "PROX1", "EOMES"),
  "OligodendrocytePrecursorCells" = c ("LHFPL3", "MEGF11", "PCDH15", "PDGFRA", "CSPG4", "RNF4"),
  "Oligodendrocytes" = c ("OLIG1", "OLIG2", "OLIG3", "CLDN11", "MBP", "MOG", "MAG", "GALC", "CNP", "SOX10", "FA2H", "UGT8"),
  "GABAergic" = c("SLC6A1", "GABBR1", "GABBR2", "GAD2", "GAD1", "SLC32A1"),
  "Glutamatergic" = c ( "SLC17A7","SLC17A6","GRIN1","GRIN2B","GLS","GLUL","GRIN2A"),
  "Sero" = c("TPH1","SLC6A4","FEV","HTR1A","HTR1B"),
  "Choli" = c("CHAT","SLC18A3","ACHE"),
  "RadialGlia" = c("PAX6", "HES1", "HES5", "FABP7", "TNC", "CDH2"),
  "vmDANeuron" = c("TH", "EN1", "LMX1A", "FOXA2", "OTX2", "SLC6A3", "SLC18A2", "DRD1", "DRD2", "NR4A2", "DDC", "DLK1", "ALDH1A2", "ADCYAP1", "CORIN", "SHH"),
  "A9vmDA" = c("PITX3", "KCNJ6", "ALDH1A1"),
  "A10vmDA" = c("CALB1"),
  "GDNF pathway" = c("GDNF", "NRTN", "RET", "GFRA1", "GFRA2", "GFRA3", "GFRA4", "FRS2", "SHC1", "MAPK1", "MAPK3", "MAP2K1", "MAP2K2"),
  "Netrin1 pathway" = c("NTN1", "DCC", "UNC5A", "UNC5B", "NEO1", "ROBO1", "DSCAM")
)

# Create an empty data frame to hold the marker names and genes
marker_gene_df <- data.frame(Marker = character(), Gene = character(), stringsAsFactors = FALSE)

# Loop through each group in vmDAList
for (group_name in names(vmDAList)) {
  markers <- vmDAList[[group_name]]
  
  # Create the DotPlot for the current group of markers
  p <- DotPlot(NeuronsOnly, features = markers, group.by = "seurat_clusters") + 
    ggtitle(group_name) +  # Set the plot title to the group name
    xlab("Gene") +         # Set the x-axis label to "Gene"
    ylab("Clusters") +      # Set the y-axis label to "Cluster"
    theme(
      plot.title = element_text(hjust = 0.5),  # Center the plot title
      axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
    )
  
  # Create a safe filename using the group name 
  safe_group_name <- str_replace_all(group_name, "[^[:alnum:]]", "_")  # Replace non-alphanumeric characters with "_"
  filename <- paste0(output_folder, "/", safe_group_name, "_NeuronsOnly_clusters.png")
  
  # Save the plot to the specified output folder
  ggsave(filename, plot = p, width = 5, height = 4)  # Adjust width and height as needed

  # Print the plot
  print(p)
}
```


# Cell Annotation

```{r}
new.cluster.ids <- c("Other Neurons", "Other Neurons", "DA Neurons", "Not Neurons", "Other Neurons", 
                     "Other Neurons", "Other Neurons", "DA Neurons", "Not Neurons", "DA Neurons", "Other Neurons", "Not Neurons", "Other Neurons")
names(new.cluster.ids) <- 0:12  # Assign numeric names to the vector elements (0 to 11)
# Assign the cell type column based on the seurat_clusters
NeuronsOnly$cell_type <- factor(as.character(new.cluster.ids[NeuronsOnly$seurat_clusters]),
levels = unique(new.cluster.ids))
NeuronsOnly <- RenameIdents(NeuronsOnly, new.cluster.ids)

# Check the first few rows to ensure it's been assigned correctly
# Assign custom colors to each group
DimPlot(NeuronsOnly)

```

# DEG

```{r}
deg_all_results <-FindAllMarkers(NeuronsOnly, min.pct = 0.5,  logfc.threshold = 0.5)
deg_all_results
 # Top 5 DEGs based on avg_log2FC
top5 <- deg_all_results %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)
DoHeatmap(NeuronsOnly, features = top5$gene, label=FALSE) 
top5
write.csv(deg_all_results, file = "deg_all_results.csv")

my.deg <- FindMarkers(NeuronsOnly, 
                            ident.1 = c("DA Neurons"), 
                            ident.2 = c("Other Neurons"), 
                            verbose = FALSE)

g<-EnhancedVolcano(my.deg, 
                lab = rownames(my.deg),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = NULL
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_blank(),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

```

#Gene Ontology

```{r}
#Save Marker Genes
nonDA.markers.upreg <- deg_all_results[deg_all_results$cluster=="Other Neurons"
                                 & deg_all_results$avg_log2FC >0                                
                                   & deg_all_results$p_val_adj < 0.05,  ]
nonDA.markers.upreg.cutoff1 <- deg_all_results[deg_all_results$cluster=="Other Neurons"
                                 & deg_all_results$avg_log2FC >0                                
                                   & deg_all_results$p_val_adj < 0.05,  ]
nonDA.markers.downreg <- deg_all_results[deg_all_results$cluster=="Other Neurons"
                                 & deg_all_results$avg_log2FC <0                                
                                   & deg_all_results$p_val_adj < 0.05,  ]
nonDA.markers.downreg.cutoff1 <- deg_all_results[deg_all_results$cluster=="Other Neurons"
                                 & deg_all_results$avg_log2FC < (-1)                                
                                   & deg_all_results$p_val_adj < 0.05,  ]

DA.markers.upreg <- deg_all_results[deg_all_results$cluster=="DA Neurons" 
                                    & deg_all_results$avg_log2FC >0  
                              & deg_all_results$p_val_adj < 0.05,  ]
DA.markers.upreg.cutoff1 <- deg_all_results[deg_all_results$cluster=="DA Neurons" 
                                    & deg_all_results$avg_log2FC >1  
                              & deg_all_results$p_val_adj < 0.05,  ]
DA.markers.downreg <- deg_all_results[deg_all_results$cluster=="DA Neurons" 
                                    & deg_all_results$avg_log2FC <0  
                              & deg_all_results$p_val_adj < 0.05,  ]
DA.markers.downreg.cutoff1 <- deg_all_results[deg_all_results$cluster=="DA Neurons" 
                                    & deg_all_results$avg_log2FC < -1  
                              & deg_all_results$p_val_adj < 0.05,  ]

#Convert gene symbols to Entrez IDs
nonDA.gene.upreg_ids <- bitr(nonDA.markers.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
nonDA.gene.downreg_ids <- bitr(nonDA.markers.downreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
DA.gene.upreg_ids <- bitr(DA.markers.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
DA.gene.downreg_ids <- bitr(DA.markers.downreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
#Perform GO enrichment analyses cellular component
nonDA.upreg.ego <- enrichGO(gene = nonDA.gene.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
nonDA.downreg.ego <- enrichGO(gene = nonDA.gene.downreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
DA.upreg.ego <- enrichGO(gene = DA.gene.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
DA.downreg.ego <- enrichGO(gene = DA.gene.downreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)

# Create a ggplot with custom coloring
ego_data <- as.data.frame(nonDA.upreg.ego)
color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:10, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for nonDA cc", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:10, ], aes(x = reorder(Description,-pvalue), 
                             y = Count, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for nonDA cc", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

# Create a ggplot with custom coloring
ego_data <- as.data.frame(DA.upreg.ego)
color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:10, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for DA cc", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:10, ], aes(x = reorder(Description,-pvalue), 
                             y = Count, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for DA cc", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))


#Perform GO enrichment analyses biological process 
nonDA.upreg.ego <- enrichGO(gene = nonDA.gene.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
nonDA.downreg.ego <- enrichGO(gene = nonDA.gene.downreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
DA.upreg.ego <- enrichGO(gene = DA.gene.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
DA.downreg.ego <- enrichGO(gene = DA.gene.downreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)

# Create a ggplot with custom coloring
ego_data <- as.data.frame(nonDA.upreg.ego)
color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:10, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for nonDA bp", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:10, ], aes(x = reorder(Description,-pvalue), 
                             y = Count, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for nonDA bp", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

# Create a ggplot with custom coloring
ego_data <- as.data.frame(DA.upreg.ego)
color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:10, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for DA bp", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:10, ], aes(x = reorder(Description,-pvalue), 
                             y = Count, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "GO Enrichment Analysis for DA bp", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

```

```{r}
#Try another GO analyses

# Rank genes by log-fold change (logFC) in decreasing order
DA.markers.upreg_with_ids <- merge(DA.markers.upreg, DA.gene.upreg_ids, by.x = "gene", by.y = "SYMBOL")
DA.markers.upreg_with_ids <- DA.markers.upreg_with_ids[!is.na(DA.markers.upreg_with_ids$ENTREZID), ]
geneList <- DA.markers.upreg_with_ids$avg_log2FC
names(geneList) <- DA.markers.upreg_with_ids$ENTREZID  # Assign ENTREZ IDs as names
geneList <- sort(geneList, decreasing = TRUE)
ego3 <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "CC",
              minGSSize    = 100,
              maxGSSize    = 500,
              verbose      = FALSE)

ego_data <- as.data.frame(ego3)

color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:8, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "Top 8 gseGO for DA", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:8, ], aes(x = reorder(Description,-pvalue), 
                             y = setSize, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "Top 8 gseGO for DA", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

#KEGG

DA.kegg <- enrichKEGG(gene = DA.gene.upreg_ids$ENTREZID, 
                      organism = "hsa", # Use "hsa" for Homo sapiens (adjust if needed for other species)
                      pvalueCutoff = 0.05)
view(DA.kegg)
ego_data <- as.data.frame(DA.kegg)
color_palette <- sequential_hcl(10, palette = "Reds", rev = TRUE)
ggplot(ego_data[1:10, ], aes(x = reorder(Description, -pvalue), 
                             y = -log10(pvalue), 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "Top 10 Enriched KEGG Pathways DA ", x = "", y = "-log10(pvalue)") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))

ggplot(ego_data[1:10, ], aes(x = reorder(Description,-pvalue), 
                             y = Count, 
                             fill = factor(-log10(pvalue)))) +  # Use factor for discrete colors
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  scale_fill_manual(values = color_palette) +  # Apply discrete colors
  labs(title = "Top 10 Enriched KEGG Pathways DA", x = "", y = "GeneCounts") +
  theme_minimal()+
  guides(fill = guide_legend(title = "-log10(pvalue)"))
# Assuming you have run enrichKEGG and have DA.gene_ids$ENTREZID (your gene IDs)
# and DA.kegg which contains the KEGG pathway enrichment data

# Visualize the specific pathway (hsa04728)
pathview(
  gene.data = DA.gene.upreg_ids$ENTREZID,  # Your gene IDs from DA.gene_ids$ENTREZID
  pathway.id = "hsa04728",           # Pathway to visualize
  species = "hsa",                   # Homo sapiens (adjust if using another species)
  out.suffix = "hsa04728"            # Suffix for output files
)
pathview(
  gene.data = geneList,
  pathway.id = "hsa04728",
  species = "hsa",
  out.suffix = "hsa04728_expression",
  limit      = list(gene=max(abs(geneList)))
)

browseKEGG(DA.kegg, 'hsa04721')
browseKEGG(DA.kegg, 'hsa04728')


# Rank genes by log-fold change (logFC) in decreasing order

DA.markers.upreg_with_ids <- merge(DA.markers.upreg, DA.gene.upreg_ids, by.x = "gene", by.y = "SYMBOL")
DA.markers.upreg_with_ids <- DA.markers.upreg_with_ids[!is.na(DA.markers.upreg_with_ids$ENTREZID), ]
geneList <- DA.markers.upreg_with_ids$avg_log2FC
names(geneList) <- DA.markers.upreg_with_ids$ENTREZID  # Assign ENTREZ IDs as names
geneList <- sort(geneList, decreasing = TRUE)

# Run GSEA for KEGG pathways
gse_result <- gseKEGG(gene = geneList,
                      minGSSize = 10,    # Minimum gene set size
                      pvalueCutoff = 0.1,  # Relaxed p-value threshold
                      organism = "hsa",  # Specify human (hsa) KEGG pathways
                      verbose = FALSE,
                      scoreType = "pos")  # Suppress verbose output

# Check the result

dotplot(gse_result, showCategory = 4, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)

# Try brain specific GO (Brain_GMT)
DA.markers.upreg_with_ids <- merge(DA.markers.upreg, DA.gene.upreg_ids, by.x = "gene", by.y = "SYMBOL")
DA.markers.upreg_with_ids <- DA.markers.upreg_with_ids[!is.na(DA.markers.upreg_with_ids$ENTREZID), ]
geneList <- DA.markers.upreg_with_ids$avg_log2FC
view(geneList)
names(geneList) <- DA.markers.upreg_with_ids$gene  # Assign gene IDs as names
geneList <- sort(geneList, decreasing = FALSE)
view(geneList)
BrainGMT<-gmtPathways("/data/gpfs/projects/punim2346/chiara/projects/axonal_guidance/analyses/R_output/20250317_GEMX_FLEX_POOL1/Merged/Data Neurons Only/BrainGMTv2_HumanOrthologs.gmt.txt")
GSEA_Results<-fgsea(BrainGMT, geneList,minSize = 10, maxSize = 1000)
GSEA_Results$leadingEdge<-vapply(GSEA_Results$leadingEdge, paste, collapse= ",", character(1L))
view(GSEA_Results)
write.csv(GSEA_Results, "GSEA_Results.csv")
head(GSEA_Results[order(-size, -abs(NES)), ], n=10)
pathway_name <- "MANNO_MIDBRAIN_NEUROTYPES_HDA1"
plotEnrichment(BrainGMT[[pathway_name]], geneList) +
  ggtitle(paste("Enrichment Plot for", pathway_name))

# Create a new column with -log10(p-value)
GSEA_Results$negLogPval <- -log10(GSEA_Results$pval)

# Select the top pathways (e.g., top 10 pathways)
top_pathways <- GSEA_Results[order(GSEA_Results$size, decreasing = TRUE), ][1:5, ]

# Create a barplot of the top 10 pathways based on -log10(p-value)
ggplot(top_pathways, aes(x = reorder(pathway, negLogPval), y = negLogPval, fill = negLogPval)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the plot for better readability
  labs(title = "Top 10 Enriched Pathways", x = "Pathway", y = "-log10(p-value)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8)) + 
  scale_fill_gradient(low = "lightblue", high = "red")  # Color gradient based on p-value


```


# DEG per sample

```{r}

# Make another column in metadata showing what cells belong to each treatment group
NeuronsOnly$celltype.and.sampleID <- paste0(NeuronsOnly$cell_type, '_', NeuronsOnly$SampleID)
Idents(NeuronsOnly) <- NeuronsOnly$celltype.and.sampleID
DimPlot(NeuronsOnly, reduction = "umap", label = T) # each cluster is now made up of two labels (control or stimulated)
DimPlot(NeuronsOnly, reduction = "umap", 
        label = T, split.by = "SampleID") # Lets separate by condition to see what we've done a bit more clearly

# Find markers of DA neurons
treatment.response.DA.Sample1vs3 <- FindMarkers(NeuronsOnly, ident.1 = 'DA Neurons_Sample1', 
                                       ident.2 = 'DA Neurons_Sample3')
treatment.response.DA.Sample1vs3$gene <- rownames(treatment.response.DA.Sample1vs3)
treatment.response.DA.Sample2vs3 <- FindMarkers(NeuronsOnly, ident.1 = 'DA Neurons_Sample2', 
                                       ident.2 = 'DA Neurons_Sample3')
treatment.response.DA.Sample2vs3$gene <- rownames(treatment.response.DA.Sample2vs3)
treatment.response.DA.Sample1vs2 <- FindMarkers(NeuronsOnly, ident.1 = 'DA Neurons_Sample1', 
                                       ident.2 = 'DA Neurons_Sample2')
treatment.response.DA.Sample1vs2$gene <- rownames(treatment.response.DA.Sample1vs2)
write.csv(treatment.response.DA.Sample1vs3, file = "treatment.response.DA.Sample1vs3.csv")
write.csv(treatment.response.DA.Sample2vs3, file = "treatment.response.DA.Sample2vs3.csv")
write.csv(treatment.response.DA.Sample1vs2, file = "treatment.response.DA.Sample1vs2.csv")

# Volcano Plot

g<-EnhancedVolcano(treatment.response.DA.Sample1vs3, 
                lab = rownames(treatment.response.DA.Sample1vs3),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "DA Neurons: Sample 1 vs 3" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

g<-EnhancedVolcano(treatment.response.DA.Sample2vs3, 
                lab = rownames(treatment.response.DA.Sample2vs3),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "DA Neurons: Sample 2 vs 3" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

#Try different Violin PLot
# Step 1: Filter the top 10 upregulated and downregulated genes (with avg_log2FC between -1 and +1)
upregulated_genes <- treatment.response.DA.Sample1vs3 %>%
  filter(avg_log2FC > 1) %>%
  arrange(p_val_adj) %>%
  head(15)  # Select top 10 upregulated genes

downregulated_genes <- treatment.response.DA.Sample1vs3 %>%
  filter(avg_log2FC < -1) %>%
  filter(p_val_adj<0.00001) %>%
  head(10)  # Select top 10 downregulated genes

# Combine the top 10 upregulated and downregulated genes
top_genes <- bind_rows(upregulated_genes, downregulated_genes)

# Step 2: Add a color category column based on your logic
treatment.response.DA.Sample1vs3$color <- with(treatment.response.DA.Sample1vs3, ifelse(
  (avg_log2FC > 1 & -log10(p_val_adj) > 5) | (avg_log2FC < -1 & -log10(p_val_adj) > 5), "red",
  ifelse((-log10(p_val_adj) > 5 & avg_log2FC >= -1 & avg_log2FC <= 1), "blue",
    ifelse((-log10(p_val_adj) < 5 & (avg_log2FC > 1 | avg_log2FC < -1)), "darkgreen", "grey")
  )
))
# Add the color column to the top_genes data frame as well
top_genes$color <- with(top_genes, ifelse(
  (avg_log2FC > 1 & -log10(p_val_adj) > 5) | (avg_log2FC < -1 & -log10(p_val_adj) > 5), "red",
  ifelse((-log10(p_val_adj) > 5 & avg_log2FC >= -1 & avg_log2FC <= 1), "blue",
         ifelse((-log10(p_val_adj) < 5 & (avg_log2FC > 1 | avg_log2FC < -1)), "darkgreen", "grey")
  )
))
# Step 3: Create the plot
ggplot(treatment.response.DA.Sample1vs3, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
  geom_point(size = 1) +  # Small dots
  geom_hline(yintercept = 5, color = "red", linetype = "dashed") + 
  geom_vline(xintercept = 1, color = "blue", linetype = "dashed") +
  geom_vline(xintercept = -1, color = "blue", linetype = "dashed") +
  
  # Step 4: Label only the top 10 upregulated and downregulated genes
  geom_text_repel(data = top_genes, 
                  aes(label = rownames(top_genes)),
                  size = 2.5, box.padding = 0.3, max.overlaps = Inf) +
  
  scale_color_identity() +  # Use the exact colors from your data
  labs(
    x = "avg. log2-fold change",
    y = "-log10(adjusted p-value)",
    title = "treatment.response.DA.Sample1vs3"
  ) +
  theme_minimal()

#Filter the results pct.1>0.5  pct.2 <0.5 or pct.1<0.5  pct.2 >0.5

treatment.response.DA.Sample2vs3.filt<-treatment.response.DA.Sample2vs3 %>%filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))
treatment.response.DA.Sample1vs3.filt<-treatment.response.DA.Sample1vs3%>% filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))
treatment.response.DA.Sample1vs2.filt<-treatment.response.DA.Sample1vs2%>% filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))
write.csv(treatment.response.DA.Sample1vs3.filt, file = "treatment.response.DA.Sample1vs3.filt.csv")
write.csv(treatment.response.DA.Sample2vs3.filt, file = "treatment.response.DA.Sample2vs3.filt.csv")
write.csv(treatment.response.DA.Sample1vs2.filt, file = "treatment.response.DA.Sample1vs2.filt.csv")


#Volcano Plot

g<-EnhancedVolcano(treatment.response.DA.Sample1vs3.filt, 
                lab = rownames(treatment.response.DA.Sample1vs3.filt),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "DA Neurons: Sample 1 vs 3 filtered" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

g<-EnhancedVolcano(treatment.response.DA.Sample2vs3.filt, 
                lab = rownames(treatment.response.DA.Sample2vs3.filt),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "DA Neurons: Sample 2 vs 3 filtered" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g
```

#GO per sample filtered

```{r}
#Convert gene symbols to Entrez IDs
treatment.response.DA.Sample1vs3.filt.upreg <- treatment.response.DA.Sample1vs3.filt[treatment.response.DA.Sample1vs3.filt$avg_log2FC >0                                
                                   & treatment.response.DA.Sample1vs3.filt < 0.05,  ]
treatment.response.DA.Sample1vs3.filt.upreg_ids <- bitr(treatment.response.DA.Sample1vs3.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.DA.Sample2vs3.filt.upreg <- treatment.response.DA.Sample2vs3.filt[treatment.response.DA.Sample2vs3.filt$avg_log2FC >0                                
                                   & treatment.response.DA.Sample2vs3.filt$p_val_adj < 0.05,  ]
treatment.response.DA.Sample2vs3.filt.upreg_ids <- bitr(treatment.response.DA.Sample2vs3.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.DA.Sample1vs2.filt.upreg <- treatment.response.DA.Sample1vs2.filt[treatment.response.DA.Sample1vs2.filt$avg_log2FC >0                                
                                   & treatment.response.DA.Sample1vs2.filt$p_val_adj < 0.05,  ]
treatment.response.DA.Sample1vs2.filt.upreg_ids <- bitr(treatment.response.DA.Sample1vs2.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)

#Perform and save GO enrichment analyses (Cellular Component )
treatment.response.DA.Sample1vs3.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.DA.Sample1vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs3.filt.upreg_ids, file="treatment.response.DA.Sample1vs3.filt.upreg_ids.csv")
write.csv(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego, file = "treatment.response.DA.Sample1vs3.filt.upreg.cc.ego.csv")

treatment.response.DA.Sample2vs3.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.DA.Sample2vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample2vs3.filt.upreg_ids, file="treatment.response.DA.Sample2vs3.filt.upreg_ids.csv")
write.csv(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego, file = "treatment.response.DA.Sample2vs3.filt.upreg.cc.ego.csv")

treatment.response.DA.Sample1vs2.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.DA.Sample1vs2.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs2.filt.upreg_ids, file="treatment.response.DA.Sample1vs2.filt.upreg_ids.csv")
write.csv(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego, file = "treatment.response.DA.Sample1vs2.filt.upreg.cc.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))
 #dotplot
p1 <- dotplot(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))

#enrichmentmap
treatment.response.DA.Sample1vs3.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego)
emapplot(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego, showCategory=20)
treatment.response.DA.Sample2vs3.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego)
emapplot(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego, showCategory=20)
treatment.response.DA.Sample1vs2.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego)
emapplot(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego, showCategory=20)

#Cnetplot
#Sample1vs3
treatment.response.DA.Sample1vs3.filt.upreg_ids_FC <- merge(
  treatment.response.DA.Sample1vs3.filt.upreg_ids, 
  treatment.response.DA.Sample1vs3.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample1vs3.filt.upreg_ids_FC <- treatment.response.DA.Sample1vs3.filt.upreg_ids_FC[
  order(match(treatment.response.DA.Sample1vs3.filt.upreg_ids_FC$SYMBOL, treatment.response.DA.Sample1vs3.filt.upreg$gene)), 
]
rownames(treatment.response.DA.Sample1vs3.filt.upreg_ids_FC) <- 1:nrow(treatment.response.DA.Sample1vs3.filt.upreg_ids_FC)
cnetplot(treatment.response.DA.Sample1vs3.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample1vs3.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)

#Sample2vs3
treatment.response.DA.Sample2vs3.filt.upreg_ids_FC <- merge(
  treatment.response.DA.Sample2vs3.filt.upreg_ids, 
  treatment.response.DA.Sample2vs3.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample2vs3.filt.upreg_ids_FC <- treatment.response.DA.Sample2vs3.filt.upreg_ids_FC[
  order(match(treatment.response.DA.Sample2vs3.filt.upreg_ids_FC$SYMBOL, treatment.response.DA.Sample2vs3.filt.upreg$gene)), 
]
rownames(treatment.response.DA.Sample2vs3.filt.upreg_ids_FC) <- 1:nrow(treatment.response.DA.Sample2vs3.filt.upreg_ids_FC)
cnetplot(treatment.response.DA.Sample2vs3.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample2vs3.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)

#Sample1vs2
treatment.response.DA.Sample1vs2.filt.upreg_ids_FC <- merge(
  treatment.response.DA.Sample1vs2.filt.upreg_ids, 
  treatment.response.DA.Sample1vs2.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample1vs2.filt.upreg_ids_FC <- treatment.response.DA.Sample1vs2.filt.upreg_ids_FC[
  order(match(treatment.response.DA.Sample1vs2.filt.upreg_ids_FC$SYMBOL, treatment.response.DA.Sample1vs2.filt.upreg$gene)), 
]
rownames(treatment.response.DA.Sample1vs2.filt.upreg_ids_FC) <- 1:nrow(treatment.response.DA.Sample1vs2.filt.upreg_ids_FC)
cnetplot(treatment.response.DA.Sample1vs2.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample1vs2.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)


#Perform and save GO enrichment analyses (biological process )
treatment.response.DA.Sample1vs3.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.DA.Sample1vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs3.filt.upreg.bp.ego, file = "treatment.response.DA.Sample1vs3.filt.upreg.bp.ego.csv")
treatment.response.DA.Sample2vs3.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.DA.Sample2vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample2vs3.filt.upreg.bp.ego, file = "treatment.response.DA.Sample2vs3.filt.upreg.bp.ego.csv")
treatment.response.DA.Sample1vs2.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.DA.Sample1vs2.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs2.filt.upreg.bp.ego, file = "treatment.response.DA.Sample1vs2.filt.upreg.bp.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.DA.Sample1vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample2vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample1vs2.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#dotplot
p1 <- dotplot(treatment.response.DA.Sample1vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample2vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample1vs2.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#enrichmentmap
treatment.response.DA.Sample1vs3.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.DA.Sample1vs3.filt.upreg.bp.ego)
emapplot(treatment.response.DA.Sample1vs3.filt.upreg.bp.ego, showCategory=20)
treatment.response.DA.Sample2vs3.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.DA.Sample2vs3.filt.upreg.bp.ego)
emapplot(treatment.response.DA.Sample2vs3.filt.upreg.bp.ego, showCategory=20)
treatment.response.DA.Sample1vs2.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.DA.Sample1vs2.filt.upreg.bp.ego)
emapplot(treatment.response.DA.Sample1vs2.filt.upreg.bp.ego, showCategory=20)

```
 

#GO per sample not filtered

```{r}
#Convert gene symbols to Entrez IDs

treatment.response.DA.Sample1vs3_ids <- bitr(treatment.response.DA.Sample1vs3$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.DA.Sample2vs3_ids <- bitr(treatment.response.DA.Sample2vs3$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.DA.Sample1vs2_ids <- bitr(treatment.response.DA.Sample1vs2$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)

#Perform and save GO enrichment analyses (Cellular Component )
treatment.response.DA.Sample1vs3.cc.ego <- enrichGO(gene = treatment.response.DA.Sample1vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs3.cc.ego, file = "treatment.response.DA.Sample1vs3.cc.ego.csv")
treatment.response.DA.Sample2vs3.cc.ego <- enrichGO(gene = treatment.response.DA.Sample2vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample2vs3.cc.ego, file = "treatment.response.DA.Sample2vs3.cc.ego.csv")
treatment.response.DA.Sample1vs2.cc.ego <- enrichGO(gene = treatment.response.DA.Sample1vs2_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs2.cc.ego, file = "treatment.response.DA.Sample1vs2.cc.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.DA.Sample1vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample2vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample1vs2.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))
 #dotplot
p1 <- dotplot(treatment.response.DA.Sample1vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample2vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample1vs2.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))

#enrichmentmap
treatment.response.DA.Sample1vs3.cc.ego <- pairwise_termsim(treatment.response.DA.Sample1vs3.cc.ego)
emapplot(treatment.response.DA.Sample1vs3.cc.ego, showCategory=20)
treatment.response.DA.Sample2vs3.cc.ego <- pairwise_termsim(treatment.response.DA.Sample2vs3.cc.ego)
emapplot(treatment.response.DA.Sample2vs3.cc.ego, showCategory=20)
treatment.response.DA.Sample1vs2.cc.ego <- pairwise_termsim(treatment.response.DA.Sample1vs2.cc.ego)
emapplot(treatment.response.DA.Sample1vs2.cc.ego, showCategory=20)

#Cnetplot
#Sample1vs3
treatment.response.DA.Sample1vs3_ids_FC <- merge(
  treatment.response.DA.Sample1vs3_ids, 
  treatment.response.DA.Sample1vs3[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample1vs3_ids_FC <- treatment.response.DA.Sample1vs3_ids_FC[
  order(match(treatment.response.DA.Sample1vs3_ids_FC$SYMBOL, treatment.response.DA.Sample1vs3$gene)), 
]
rownames(treatment.response.DA.Sample1vs3_ids_FC) <- 1:nrow(treatment.response.DA.Sample1vs3_ids_FC)
cnetplot(treatment.response.DA.Sample1vs3.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample1vs3_ids_FC$avg_log2FC, showCategory = 4)

#Sample2vs3
treatment.response.DA.Sample2vs3_ids_FC <- merge(
  treatment.response.DA.Sample2vs3_ids, 
  treatment.response.DA.Sample2vs3[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample2vs3_ids_FC <- treatment.response.DA.Sample2vs3_ids_FC[
  order(match(treatment.response.DA.Sample2vs3_ids_FC$SYMBOL, treatment.response.DA.Sample2vs3$gene)), 
]
rownames(treatment.response.DA.Sample2vs3_ids_FC) <- 1:nrow(treatment.response.DA.Sample2vs3_ids_FC)
cnetplot(treatment.response.DA.Sample2vs3.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample2vs3_ids_FC$avg_log2FC, showCategory = 4)

#Sampl1vs2
treatment.response.DA.Sample1vs2_ids_FC <- merge(
  treatment.response.DA.Sample1vs2_ids, 
  treatment.response.DA.Sample1vs2[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.DA.Sample1vs2_ids_FC <- treatment.response.DA.Sample1vs2_ids_FC[
  order(match(treatment.response.DA.Sample1vs2_ids_FC$SYMBOL, treatment.response.DA.Sample1vs2$gene)), 
]
rownames(treatment.response.DA.Sample1vs2_ids_FC) <- 1:nrow(treatment.response.DA.Sample1vs2_ids_FC)
cnetplot(treatment.response.DA.Sample1vs2.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.DA.Sample1vs2_ids_FC$avg_log2FC, showCategory = 4)


#Perform and save GO enrichment analyses (biological process )
treatment.response.DA.Sample1vs3.bp.ego <- enrichGO(gene = treatment.response.DA.Sample1vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs3.bp.ego, file = "treatment.response.DA.Sample1vs3.bp.ego.csv")
treatment.response.DA.Sample2vs3.bp.ego <- enrichGO(gene = treatment.response.DA.Sample2vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample2vs3.bp.ego, file = "treatment.response.DA.Sample2vs3.bp.ego.csv")
treatment.response.DA.Sample1vs2.bp.ego <- enrichGO(gene = treatment.response.DA.Sample1vs2_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.DA.Sample1vs2.bp.ego, file = "treatment.response.DA.Sample1vs2.bp.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.DA.Sample1vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample2vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.DA.Sample1vs2.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#dotplot
p1 <- dotplot(treatment.response.DA.Sample1vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample2vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.DA.Sample1vs2.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for DA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#enrichmentmap
treatment.response.DA.Sample1vs3.bp.ego <- pairwise_termsim(treatment.response.DA.Sample1vs3.bp.ego)
emapplot(treatment.response.DA.Sample1vs3.bp.ego, showCategory=20)
treatment.response.DA.Sample2vs3.bp.ego <- pairwise_termsim(treatment.response.DA.Sample2vs3.bp.ego)
emapplot(treatment.response.DA.Sample2vs3.bp.ego, showCategory=20)
treatment.response.DA.Sample1vs2.bp.ego <- pairwise_termsim(treatment.response.DA.Sample1vs2.bp.ego)
emapplot(treatment.response.DA.Sample1vs2.bp.ego, showCategory=20)

```

# DEG per sample non DA

```{r}

# Find markers of non DA neurons
treatment.response.nonDA.Sample1vs3 <- FindMarkers(NeuronsOnly, ident.1 = 'Other Neurons_Sample1', 
                                       ident.2 = 'Other Neurons_Sample3')
treatment.response.nonDA.Sample1vs3$gene <- rownames(treatment.response.nonDA.Sample1vs3)
treatment.response.nonDA.Sample2vs3 <- FindMarkers(NeuronsOnly, ident.1 = 'Other Neurons_Sample2', 
                                       ident.2 = 'Other Neurons_Sample3')
treatment.response.nonDA.Sample2vs3$gene <- rownames(treatment.response.nonDA.Sample2vs3)
treatment.response.nonDA.Sample1vs2 <- FindMarkers(NeuronsOnly, ident.1 = 'Other Neurons_Sample1', 
                                       ident.2 = 'Other Neurons_Sample2')
treatment.response.nonDA.Sample1vs2$gene <- rownames(treatment.response.nonDA.Sample1vs2)
write.csv(treatment.response.nonDA.Sample1vs3, file = "treatment.response.nonDA.Sample1vs3.csv")
write.csv(treatment.response.nonDA.Sample2vs3, file = "treatment.response.nonDA.Sample2vs3.csv")
write.csv(treatment.response.nonDA.Sample1vs2, file = "treatment.response.nonDA.Sample1vs2.csv")

# Volcano Plot

g<-EnhancedVolcano(treatment.response.nonDA.Sample1vs3, 
                lab = rownames(treatment.response.nonDA.Sample1vs3),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "nonDA Neurons: Sample 1 vs 3" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

g<-EnhancedVolcano(treatment.response.nonDA.Sample2vs3, 
                lab = rownames(treatment.response.nonDA.Sample2vs3),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "nonDA Neurons: Sample 2 vs 3" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

#Filter the results pct.1>0.5  pct.2 <0.5 or pct.1<0.5  pct.2 >0.5

treatment.response.nonDA.Sample2vs3.filt<-treatment.response.nonDA.Sample2vs3 %>%filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))
treatment.response.nonDA.Sample1vs3.filt<-treatment.response.nonDA.Sample1vs3%>% filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))
treatment.response.nonDA.Sample1vs2.filt<-treatment.response.nonDA.Sample1vs2%>% filter((pct.1 > 0.5 & pct.2 < 0.5) | (pct.1 < 0.5 & pct.2 > 0.5))

write.csv(treatment.response.nonDA.Sample1vs3.filt, file = "treatment.response.nonDA.Sample1vs3.filt.csv")
write.csv(treatment.response.nonDA.Sample2vs3.filt, file = "treatment.response.nonDA.Sample2vs3.filt.csv")
write.csv(treatment.response.nonDA.Sample1vs2.filt, file = "treatment.response.nonDA.Sample1vs2.filt.csv")

#Volcano Plot

g<-EnhancedVolcano(treatment.response.nonDA.Sample1vs3.filt, 
                lab = rownames(treatment.response.nonDA.Sample1vs3.filt),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "nonDA Neurons: Sample 1 vs 3 filtered" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g

g<-EnhancedVolcano(treatment.response.nonDA.Sample2vs3.filt, 
                lab = rownames(treatment.response.nonDA.Sample2vs3.filt),
                x = "avg_log2FC",                   # X-axis is log2 fold change
                y = "p_val_adj",
                 pointSize = 2,
                labSize = 2,
                legendLabSize = 3,
                legendIconSize = 2,
                title = "nonDA Neurons: Sample 2 vs 3 filtered" ,
                xlim = c(-5, 5) 
                )+ 
  theme(
    axis.title.x = element_text(size = 4),  # Smaller font size for X-axis title
    axis.title.y = element_text(size = 4),  # Smaller font size for Y-axis title
    axis.text.x = element_text(size = 3), # Smaller font size for X-axis numbers
    axis.text.y = element_text(size = 3), # Smaller font size for Y-axis numbers
    plot.title = element_text(size=6, face = "bold"),        # Remove the plot title
    plot.margin = margin(5, 5, 5, 5)  # Optional: Adds more space around the plot
  )
g
```

#GO per sample filtered upregulated genes

```{r}
#Filter for upregulated genes
#Convert gene symbols to Entrez IDs

treatment.response.nonDA.Sample1vs3.filt.upreg <- treatment.response.nonDA.Sample1vs3.filt[treatment.response.nonDA.Sample1vs3.filt$avg_log2FC >0                                
                                   & treatment.response.nonDA.Sample1vs3.filt$p_val_adj < 0.05,  ]
treatment.response.nonDA.Sample1vs3.filt.upreg_ids <- bitr(treatment.response.nonDA.Sample1vs3.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.nonDA.Sample2vs3.filt.upreg <- treatment.response.nonDA.Sample2vs3.filt[treatment.response.nonDA.Sample2vs3.filt$avg_log2FC >0                                
                                   & treatment.response.nonDA.Sample2vs3.filt$p_val_adj < 0.05,  ]
treatment.response.nonDA.Sample2vs3.filt.upreg_ids <- bitr(treatment.response.nonDA.Sample2vs3.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.nonDA.Sample1vs2.filt.upreg <- treatment.response.nonDA.Sample1vs2.filt[treatment.response.nonDA.Sample1vs2.filt$avg_log2FC >0                                
                                   & treatment.response.nonDA.Sample1vs2.filt$p_val_adj < 0.05,  ]
treatment.response.nonDA.Sample1vs2.filt.upreg_ids <- bitr(treatment.response.nonDA.Sample1vs2.filt.upreg$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)

#Perform and save GO enrichment analyses (Cellular Component)

treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs3.filt.upreg_ids, file="treatment.response.nonDA.Sample1vs3.filt.upreg_ids.csv")
write.csv(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego, file = "treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego.csv")

treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample2vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample2vs3.filt.upreg_ids, file="treatment.response.nonDA.Sample2vs3.filt.upreg_ids.csv")
write.csv(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego, file = "treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego.csv")

treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs2.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs2.filt.upreg_ids, file="treatment.response.nonDA.Sample1vs2.filt.upreg_ids.csv")
write.csv(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego, file = "treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego.csv")

#Visualize the results of GO (Cellular Component)

#barplot
p1<-barplot(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))

#dotplot
p1 <- dotplot(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))

#enrichmentmap
treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego)
emapplot(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego, showCategory=20)
treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego)
emapplot(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego, showCategory=20)
treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego)
emapplot(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego, showCategory=20)

#Cnetplot
treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC <- merge(
  treatment.response.nonDA.Sample1vs3.filt.upreg_ids, 
  treatment.response.nonDA.Sample1vs3.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC <- treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC[
  order(match(treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC$SYMBOL, treatment.response.nonDA.Sample1vs3.filt.upreg$gene)), 
]
rownames(treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC)
cnetplot(treatment.response.nonDA.Sample1vs3.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample1vs3.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)

treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC <- merge(
  treatment.response.nonDA.Sample2vs3.filt.upreg_ids, 
  treatment.response.nonDA.Sample2vs3.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC <- treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC[
  order(match(treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC$SYMBOL, treatment.response.nonDA.Sample2vs3.filt.upreg$gene)), 
]
rownames(treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC)
cnetplot(treatment.response.nonDA.Sample2vs3.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample2vs3.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)

treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC <- merge(
  treatment.response.nonDA.Sample1vs2.filt.upreg_ids, 
  treatment.response.nonDA.Sample1vs2.filt.upreg[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC <- treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC[
  order(match(treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC$SYMBOL, treatment.response.nonDA.Sample1vs2.filt.upreg$gene)), 
]
rownames(treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC)
cnetplot(treatment.response.nonDA.Sample1vs2.filt.upreg.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample1vs2.filt.upreg_ids_FC$avg_log2FC, showCategory = 4)


#Perform and save GO enrichment analyses (Biological Process )
treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego, file = "treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego.csv")
treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample2vs3.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego, file = "treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego.csv")
treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs2.filt.upreg_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego, file = "treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego.csv")

#Visualize the results of GO (Biological Process)
#barplot
p1<-barplot(treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#dotplot
p1 <- dotplot(treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#enrichmentmap
treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego)
emapplot(treatment.response.nonDA.Sample1vs3.filt.upreg.bp.ego, showCategory=20)
treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego)
emapplot(treatment.response.nonDA.Sample2vs3.filt.upreg.bp.ego, showCategory=20)
treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego)
emapplot(treatment.response.nonDA.Sample1vs2.filt.upreg.bp.ego, showCategory=20)

```
 

#GO per sample not filtered

```{r}
#Convert gene symbols to Entrez IDs

treatment.response.nonDA.Sample1vs3_ids <- bitr(treatment.response.nonDA.Sample1vs3$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.nonDA.Sample2vs3_ids <- bitr(treatment.response.nonDA.Sample2vs3$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)
treatment.response.nonDA.Sample1vs2_ids <- bitr(treatment.response.nonDA.Sample1vs2$gene, fromType = "SYMBOL",
                                   toType = "ENTREZID", OrgDb = org.Hs.eg.db)

#Perform and save GO enrichment analyses (Cellular Component )
treatment.response.nonDA.Sample1vs3.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs3.cc.ego, file = "treatment.response.nonDA.Sample1vs3.cc.ego.csv")
treatment.response.nonDA.Sample2vs3.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample2vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample2vs3.cc.ego, file = "treatment.response.nonDA.Sample2vs3.cc.ego.csv")
treatment.response.nonDA.Sample1vs2.cc.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs2_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "CC", 
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs2.cc.ego, file = "treatment.response.nonDA.Sample1vs2.cc.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.nonDA.Sample1vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample2vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample1vs2.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))
 #dotplot
p1 <- dotplot(treatment.response.nonDA.Sample1vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample2vs3.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.cc")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample1vs2.cc.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.cc")
p1 + theme(axis.text.y = element_text(size = 7))

#enrichmentmap
treatment.response.nonDA.Sample1vs3.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs3.cc.ego)
emapplot(treatment.response.nonDA.Sample1vs3.cc.ego, showCategory=20)
treatment.response.nonDA.Sample2vs3.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample2vs3.cc.ego)
emapplot(treatment.response.nonDA.Sample2vs3.cc.ego, showCategory=20)
treatment.response.nonDA.Sample1vs2.cc.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs2.cc.ego)
emapplot(treatment.response.nonDA.Sample1vs2.cc.ego, showCategory=20)

#Cnetplot
#Sample1vs3
treatment.response.nonDA.Sample1vs3_ids_FC <- merge(
  treatment.response.nonDA.Sample1vs3_ids, 
  treatment.response.nonDA.Sample1vs3[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample1vs3_ids_FC <- treatment.response.nonDA.Sample1vs3_ids_FC[
  order(match(treatment.response.nonDA.Sample1vs3_ids_FC$SYMBOL, treatment.response.nonDA.Sample1vs3$gene)), 
]
rownames(treatment.response.nonDA.Sample1vs3_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample1vs3_ids_FC)
cnetplot(treatment.response.nonDA.Sample1vs3.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample1vs3_ids_FC$avg_log2FC, showCategory = 4)

#Sample2vs3
treatment.response.nonDA.Sample2vs3_ids_FC <- merge(
  treatment.response.nonDA.Sample2vs3_ids, 
  treatment.response.nonDA.Sample2vs3[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample2vs3_ids_FC <- treatment.response.nonDA.Sample2vs3_ids_FC[
  order(match(treatment.response.nonDA.Sample2vs3_ids_FC$SYMBOL, treatment.response.nonDA.Sample2vs3$gene)), 
]
rownames(treatment.response.nonDA.Sample2vs3_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample2vs3_ids_FC)
cnetplot(treatment.response.nonDA.Sample2vs3.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample2vs3_ids_FC$avg_log2FC, showCategory = 4)

#Sampl1vs2
treatment.response.nonDA.Sample1vs2_ids_FC <- merge(
  treatment.response.nonDA.Sample1vs2_ids, 
  treatment.response.nonDA.Sample1vs2[, c("gene", "avg_log2FC")], 
  by.x = "SYMBOL", by.y = "gene", all.x = TRUE
)
treatment.response.nonDA.Sample1vs2_ids_FC <- treatment.response.nonDA.Sample1vs2_ids_FC[
  order(match(treatment.response.nonDA.Sample1vs2_ids_FC$SYMBOL, treatment.response.nonDA.Sample1vs2$gene)), 
]
rownames(treatment.response.nonDA.Sample1vs2_ids_FC) <- 1:nrow(treatment.response.nonDA.Sample1vs2_ids_FC)
cnetplot(treatment.response.nonDA.Sample1vs2.cc.ego, categorySize="pvalue", 
         foldChange=treatment.response.nonDA.Sample1vs2_ids_FC$avg_log2FC, showCategory = 4)


#Perform and save GO enrichment analyses (biological process )
treatment.response.nonDA.Sample1vs3.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs3.bp.ego, file = "treatment.response.nonDA.Sample1vs3.bp.ego.csv")
treatment.response.nonDA.Sample2vs3.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample2vs3_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample2vs3.bp.ego, file = "treatment.response.nonDA.Sample2vs3.bp.ego.csv")
treatment.response.nonDA.Sample1vs2.bp.ego <- enrichGO(gene = treatment.response.nonDA.Sample1vs2_ids$ENTREZID, 
                OrgDb = org.Hs.eg.db, 
                ont = "BP", # biological process
                pAdjustMethod = "BH", 
                pvalueCutoff = 0.05, 
                qvalueCutoff = 0.05, 
                readable = TRUE)
write.csv(treatment.response.nonDA.Sample1vs2.bp.ego, file = "treatment.response.nonDA.Sample1vs2.bp.ego.csv")

#Visualize the results of GO
#barplot
p1<-barplot(treatment.response.nonDA.Sample1vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample2vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1<-barplot(treatment.response.nonDA.Sample1vs2.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#dotplot
p1 <- dotplot(treatment.response.nonDA.Sample1vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample2vs3.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample2vs3.bp")
p1 + theme(axis.text.y = element_text(size = 7))
p1 <- dotplot(treatment.response.nonDA.Sample1vs2.bp.ego, showCategory=20, 
        title="GO Enrichment Analysis for nonDA.Sample1vs2.bp")
p1 + theme(axis.text.y = element_text(size = 7))
#enrichmentmap
treatment.response.nonDA.Sample1vs3.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs3.bp.ego)
emapplot(treatment.response.nonDA.Sample1vs3.bp.ego, showCategory=20)
treatment.response.nonDA.Sample2vs3.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample2vs3.bp.ego)
emapplot(treatment.response.nonDA.Sample2vs3.bp.ego, showCategory=20)
treatment.response.nonDA.Sample1vs2.bp.ego <- pairwise_termsim(treatment.response.nonDA.Sample1vs2.bp.ego)
emapplot(treatment.response.nonDA.Sample1vs2.bp.ego, showCategory=20)
```

```

